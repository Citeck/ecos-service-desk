---
id: sd-request-type
name:
  ru: Заявка SD
sourceType: ECOS_MODEL
parentRef: emodel/type@case
formRef: uiserv/form@request-sd-form
journalRef: uiserv/journal@sd-request-journal
inheritForm: false
dispNameTemplate:
  ru: Заявка №${_docNum}
numTemplateRef: emodel/num-template@sd-reg-number-template
defaultCreateVariant: true
model:
  roles:
    - id: initiator-role
      name:
        ru: Инициатор
        en: Initiator
      attributes:
        - initiator
    - id: impl-first-line-role
      name:
        ru: Исполнитель 1-ой линии ТП
        en: 1st support line implementer
      attributes:
        - implFirstLineSupport
    - id: impl-second-line-role
      name:
        ru: Исполнители 2-ой линии ТП
        en: 2nd support line implementer
      attributes:
        - implSecondLineSupport
    - id: impl-third-line-role
      name:
        ru: Исполнители 3-ей линии ТП
        en: 3rd support line implementers
      attributes:
        - implThirdLineSupport
    - id: lead-tech-role
      name:
        ru: Руководитель ТП
        en: Support lead
    - id: add-partic-role
      name:
        ru: Дополнительный участник
        en: Additional participant
    - id: tech-role
      name:
        ru: Технолог ТП
        en: Support technologist
      attributes:
        - technologist
  statuses:
    - id: request-first-line
      name:
        ru: Передано 1-ой линии ТП
        en: Transferred on 1st support line
    - id: request-first-line-work
      name:
        ru: В работе на 1-ой линии ТП
        en: Working on 1st support line
    - id: request-second-line
      name:
        ru: Передано 2-ой линии ТП
        en: Transferred on 2nd support line
    - id: request-second-line-work
      name:
        ru: В работе на 2-ой линии ТП
        en: Working on 2nd support line
    - id: request-third-line
      name:
        ru: Передано 3-ей линии ТП
        en: Transferred on 3rd support line
    - id: request-third-line-work
      name:
        ru: В работе на 3-ей линии ТП
        en: Working on 3rd support line
    - id: request-approve
      name:
        ru: Подтверждение выполнения заявки
        en: Confirmation of request completion
    - id: request-clarification
      name:
        ru: На уточнении
        en: Clarify
    - id: request-hold
      name:
        ru: На удержании
        en: On hold
    - id: request-closes
      name:
        ru: Закрыта
        en: Closed
  attributes:
    - id: _docNum
      name:
        ru: Регистрационный номер
        en: Registration number
      type: NUMBER
    - id: client
      name:
        ru: Клиент
        en: Client
      type: ASSOC
      config:
        typeRef: emodel/type@clients-type
      mandatory: true
    - id: initiator
      name:
        ru: Инициатор
        en: Initiator
      type: PERSON
      mandatory: true
    - id: author
      name:
        ru: Автор
        en: author
    - id: petitionChannel
      name:
        ru: Канал обращения
        en: Channel of petition
      mandatory: true
    - id: petitionType
      name:
        ru: Тип обращения
        en: Type of petition
      type: ASSOC
      mandatory: true
    - id: serviceType
      name:
        ru: Вид сервиса
        en: Type of service
      type: ASSOC
      mandatory: true
    - id: systemModule
      name:
        ru: Модуль системы
        en: System module
      type: ASSOC
      mandatory: true
    - id: letterTopic
      name:
        ru: Тема письма
        en: Topic of the letter
      mandatory: true
    - id: letterContent
      name:
        ru: Содержание обращения
        en: Letter content
    - id: exampleLink
      name:
        ru: Ссылка на пример
        en: Link to the example
    - id: resolution
      name:
        ru: Резолюция
        en: Resolution
      mandatory: true
    - id: mark
      name:
        ru: Метка
        en: Mark
      type: ASSOC
      mandatory: true
    - id: sla
      name:
        ru: SLA
        en: SLA
      type: ASSOC
    - id: firstReactionTimestamp
      name:
        ru: Дата/Время первой реакции
        en: Date/Time first reaction
      type: DATETIME
    - id: closedTimestamp
      name:
        ru: Дата/Время закрытия
        en: Closing Date/Time
      type: DATETIME
    - id: stoppingTimestamp
      name:
        ru: Дата/Время остановки
        en: Stopping Date/Time
      type: DATETIME
    - id: implementer
      name:
        ru: Исполнитель
        en: Implementer
    - id: priority
      name:
        ru: Приоритет
        en: Priority
    - id: implFirstLineSupport
      name:
        ru: Исполнитель 1-ой линии ТП
        en: Implementer of the 1st line support
      type: AUTHORITY_GROUP
      mandatory: true
      computed:
        type: SCRIPT
        config:
          fn: |-
            var mappingClient = Records.query({
                "sourceId": "emodel/clients-mapping-type",
                "consistency": "EVENTUAL",
                "language": "predicate",
                "page": {
                    "maxItems": 1
                },
                "query": {
                    "t": "and",
                    "val": [
                        {
                            "att": "_type",
                            "t": "eq",
                            "val": "emodel/type@clients-mapping-type"
                        },
                        {
                            "att": "client",
                            "t": "eq",
                            "val": value.load("client?str")
                        }
                    ]
                },
                "sortBy": [
                    {
                        "ascending": false,
                        "attribute": "_created"
                    }
                ],
            }, {
                id: "id"
            });

            if (mappingClient.records.length > 0) {
                return Records.get(mappingClient.records[0].id).load("implFirstLineSupport");
            } else {
                var defaultMappingClient = Records.query({
                    "sourceId": "emodel/clients-mapping-type",
                    "consistency": "EVENTUAL",
                    "language": "predicate",
                    "page": {
                        "maxItems": 1
                    },
                    "query": {
                        "t": "and",
                        "val": [
                            {
                                "att": "_type",
                                "t": "eq",
                                "val": "emodel/type@clients-mapping-type"
                            },
                            {
                                "att": "client",
                                "t": "empty"
                            }
                        ]
                    },
                    "sortBy": [
                        {
                            "ascending": false,
                            "attribute": "_created"
                        }
                    ],
                }, {
                    id: "id"
                });
                    return Records.get(defaultMappingClient.records[0].id).load("implFirstLineSupport");
                }
        storingType: NONE
    - id: implSecondLineSupport
      name:
        ru: Исполнитель 2-ой линии ТП
        en: Implementer of the 2nd line support
      type: AUTHORITY_GROUP
      computed:
        type: SCRIPT
        config:
          fn: |-
            var mappingClient = Records.query({
                "sourceId": "emodel/lients-mapping-type",
                "consistency": "EVENTUAL",
                "language": "predicate",
                "page": {
                    "maxItems": 1
                },
                "query": {
                    "t": "and",
                    "val": [
                        {
                            "att": "_type",
                            "t": "eq",
                            "val": "emodel/type@clients-mapping-type"
                        },
                        {
                            "att": "client",
                            "t": "eq",
                            "val": value.load("client?str")
                        }
                    ]
                },
                "sortBy": [
                    {
                        "ascending": false,
                        "attribute": "_created"
                    }
                ],
            }, {
                id: "id"
            });

            if (mappingClient.records.length > 0) {
                return Records.get(mappingClient.records[0].id).load("implSecondLineSupport");
            } else {
                var defaultMappingClient = Records.query({
                    "sourceId": "emodel/clients-mapping-type",
                    "consistency": "EVENTUAL",
                    "language": "predicate",
                    "page": {
                        "maxItems": 1
                    },
                    "query": {
                        "t": "and",
                        "val": [
                            {
                                "att": "_type",
                                "t": "eq",
                                "val": "emodel/type@clients-mapping-type"
                            },
                            {
                                "att": "client",
                                "t": "empty"
                            }
                        ]
                    },
                    "sortBy": [
                        {
                            "ascending": false,
                            "attribute": "_created"
                        }
                    ],
                }, {
                    id: "id"
                });
                    return Records.get(defaultMappingClient.records[0].id).load("implSecondLineSupport");
                }
        storingType: NONE
    - id: implThirdLineSupport
      name:
        ru: Исполнитель 3-ей линии ТП
        en: Implementer of the 3rd line support
      type: AUTHORITY_GROUP
      computed:
        type: SCRIPT
        config:
          fn: |-
            var mappingClient = Records.query({
                "sourceId": "emodel/clients-mapping-type",
                "consistency": "EVENTUAL",
                "language": "predicate",
                "page": {
                    "maxItems": 1
                },
                "query": {
                    "t": "and",
                    "val": [
                        {
                            "att": "_type",
                            "t": "eq",
                            "val": "emodel/type@clients-mapping-type"
                        },
                        {
                            "att": "client",
                            "t": "eq",
                            "val": value.load("client?str")
                        }
                    ]
                },
                "sortBy": [
                    {
                        "ascending": false,
                        "attribute": "_created"
                    }
                ],
            }, {
                id: "id"
            });

            if (mappingClient.records.length > 0) {
                return Records.get(mappingClient.records[0].id).load("implThirdLineSupport");
            } else {
                var defaultMappingClient = Records.query({
                    "sourceId": "emodel/clients-mapping-type",
                    "consistency": "EVENTUAL",
                    "language": "predicate",
                    "page": {
                        "maxItems": 1
                    },
                    "query": {
                        "t": "and",
                        "val": [
                            {
                                "att": "_type",
                                "t": "eq",
                                "val": "emodel/type@clients-mapping-type"
                            },
                            {
                                "att": "client",
                                "t": "empty"
                            }
                        ]
                    },
                    "sortBy": [
                        {
                            "ascending": false,
                            "attribute": "_created"
                        }
                    ],
                }, {
                    id: "id"
                });
                    return Records.get(defaultMappingClient.records[0].id).load("implThirdLineSupport");
                }
        storingType: NONE
    - id: technologist
      name:
        ru: Технолог
        en: Technologist
      type: AUTHORITY_GROUP
      computed:
        type: SCRIPT
        config:
          fn: |-
            var mappingClient = Records.query({
                "sourceId": "emodel/clients-mapping-type",
                "consistency": "EVENTUAL",
                "language": "predicate",
                "page": {
                    "maxItems": 1
                },
                "query": {
                    "t": "and",
                    "val": [
                        {
                            "att": "_type",
                            "t": "eq",
                            "val": "emodel/type@clients-mapping-type"
                        },
                        {
                            "att": "client",
                            "t": "eq",
                            "val": value.load("client?str")
                        }
                    ]
                },
                "sortBy": [
                    {
                        "ascending": false,
                        "attribute": "_created"
                    }
                ],
            }, {
                id: "id"
            });

            if (mappingClient.records.length > 0) {
                return Records.get(mappingClient.records[0].id).load("technologist");
            } else {
                var defaultMappingClient = Records.query({
                    "sourceId": "emodel/clients-mapping-type",
                    "consistency": "EVENTUAL",
                    "language": "predicate",
                    "page": {
                        "maxItems": 1
                    },
                    "query": {
                        "t": "and",
                        "val": [
                            {
                                "att": "_type",
                                "t": "eq",
                                "val": "emodel/type@clients-mapping-type"
                            },
                            {
                                "att": "client",
                                "t": "empty"
                            }
                        ]
                    },
                    "sortBy": [
                        {
                            "ascending": false,
                            "attribute": "_created"
                        }
                    ],
                }, {
                    id: "id"
                });
                    return Records.get(defaultMappingClient.records[0].id).load("technologist");
                }
        storingType: NONE
